<?php
session_start();
include("../../admincp/config/config.php");

// Kh·ªüi t·∫°o c√°c bi·∫øn c·∫ßn thi·∫øt cho DB (Ki·ªÉm tra xem kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a)
$id_khachhang = $_SESSION['idkhachhang'] ?? null;
$code_cart = $_SESSION['code_cart'] ?? null; // C·∫ßn ch·∫Øc ch·∫Øn b·∫°n ƒë√£ t·∫°o $_SESSION['code_cart'] khi ƒëƒÉng nh·∫≠p/t·∫°o gi·ªè h√†ng

// S·ª≠a: Load gi·ªè h√†ng t·ª´ DB n·∫øu ch∆∞a c√≥ trong session
if (!isset($_SESSION['cart']) && $id_khachhang && $code_cart) {
    // ... (Gi·ªØ nguy√™n logic load t·ª´ DB l√™n session) ...
    $query = mysqli_query($mysqli, "SELECT c.*, s.tensanpham, s.giaban, s.soluongconlai 
        FROM tbl_chitiet_giohang c 
        JOIN tbl_sanpham s ON c.idsanpham = s.idsanpham 
        WHERE c.code_cart = '$code_cart'");

    $cart = [];
    while ($row = mysqli_fetch_array($query)) {
        $cart[] = [
            'id' => $row['idsanpham'], // S·ª≠a: L·∫•y idsanpham
            'tensanpham' => $row['tensanpham'],
            'giaban' => $row['giaban'], // S·ª≠a: D√πng giaban (n·∫øu ƒë√≥ l√† gi√° b√°n cu·ªëi c√πng)
            'soluong' => $row['soluong'], // S·ª≠a: T√™n c·ªôt s·ªë l∆∞·ª£ng trong chi ti·∫øt gi·ªè h√†ng
            'soluongconlai' => $row['soluongconlai'],
            'hinhanh' => $row['hinhanh'], // C√≥ th·ªÉ c·∫ßn th√™m
            'masanpham' => $row['masanpham'], // C√≥ th·ªÉ c·∫ßn th√™m
        ];
    }
    $_SESSION['cart'] = $cart;
}

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b·∫±ng AJAX (Gi·ªØ nguy√™n, nh∆∞ng ƒë·∫£m b·∫£o t√™n c·ªôt trong DB ch√≠nh x√°c: soluong)
if (isset($_POST['action']) && $_POST['action'] == 'update') {
    $id = $_POST['id'];
    $type = $_POST['type']; // 'plus' ho·∫∑c 'minus'

    foreach ($_SESSION['cart'] as &$item) {
        if ($item['id'] == $id) {
            // L·∫•y s·ªë l∆∞·ª£ng c√≤n l·∫°i t·ª´ DB
            $result = mysqli_query($mysqli, "SELECT soluongconlai FROM tbl_sanpham WHERE idsanpham = '$id'"); // S·ª≠a: idsanpham
            $row = mysqli_fetch_array($result);
            $max = $row['soluongconlai'];

            if ($type == 'plus' && $item['soluong'] < $max) {
                $item['soluong'] += 1;
            } elseif ($type == 'minus') {
                $item['soluong'] -= 1;
                if ($item['soluong'] < 1) {
                    echo json_encode(['confirm_delete' => true]);
                    exit;
                }
            }

            // C·∫≠p nh·∫≠t DB n·∫øu c√≥ ƒëƒÉng nh·∫≠p
            if ($id_khachhang && $code_cart) {
                $new_qty = $item['soluong'];
                // S·ª≠a: T√™n c·ªôt s·ªë l∆∞·ª£ng trong DB ph·∫£i kh·ªõp (v√≠ d·ª•: soluong)
                mysqli_query($mysqli, "UPDATE tbl_chitiet_giohang SET soluong = '$new_qty' 
                    WHERE code_cart = '$code_cart' AND idsanpham = '$id'");
            }

            break;
        }
    }
    echo json_encode(['success' => true]);
    exit;
}

// Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng (Logic ch√≠nh ƒë√£ ƒë∆∞·ª£c s·ª≠a)
if (isset($_POST['themgiohang'])) {
    $id = $_GET['idsanpham'];
    
    // üí° S·ª¨A ƒê·ªîI QUAN TR·ªåNG: C·ªë ƒë·ªãnh s·ªë l∆∞·ª£ng th√™m v√†o l√† 1
    $so_luong_them_moi = 1; 

    // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ DB
    $sql = "SELECT * FROM tbl_sanpham WHERE idsanpham = '".$id."' LIMIT 1";
    $query = mysqli_query($mysqli, $sql);
    $row = mysqli_fetch_array($query);

    if ($row) {
        // Chu·∫©n b·ªã s·∫£n ph·∫©m m·ªõi
        $new_product_data = [
            'tensanpham' => $row['tensanpham'],
            'id' => $row['idsanpham'],
            'soluong' => $so_luong_them_moi, // S·ª¨ D·ª§NG GI√Å TR·ªä C·ªê ƒê·ªäNH 1
            'giaban' => $row['giaban'],
            'hinhanh' => $row['hinhanh'],
            'masanpham' => $row['masanpham'],
            'soluongconlai' => $row['soluongconlai']
        ];
        
        $new_product = array($new_product_data);

        // X·ª≠ l√Ω Session Cart
        if (isset($_SESSION['cart']) && is_array($_SESSION['cart'])) {
            $found = false;
            $product = [];

            foreach ($_SESSION['cart'] as $cart_item) {
                if ($cart_item['id'] == $id) {
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m tr√πng (c·ªông th√™m 1)
                    $new_qty_in_cart = $cart_item['soluong'] + $so_luong_them_moi; // C·ªông th√™m 1
                    
                    $product[] = array_merge($cart_item, ['soluong' => $new_qty_in_cart]);
                    $found = true;
                } else {
                    $product[] = $cart_item;
                }
            }
            
            if (!$found) {
                // Th√™m s·∫£n ph·∫©m m·ªõi (s·ªë l∆∞·ª£ng l√† 1)
                $_SESSION['cart'] = array_merge($product, $new_product);
            } else {
                // C·∫≠p nh·∫≠t session cart v·ªõi s·ªë l∆∞·ª£ng m·ªõi
                $_SESSION['cart'] = $product;
            }
        } else {
            // T·∫°o m·ªõi session cart (s·ªë l∆∞·ª£ng l√† 1)
            $_SESSION['cart'] = $new_product;
        }

        // ----------------------------------------------------------------
        // LOGIC L∆ØU V√ÄO DATABASE
        // ----------------------------------------------------------------
        if ($id_khachhang) {
            
            // 1. Ki·ªÉm tra/T·∫°o code_cart n·∫øu ch∆∞a c√≥
            if (!$code_cart) {
                $code_cart = time();
                $_SESSION['code_cart'] = $code_cart;
            }
            
            // 2. Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ c√≥ trong tbl_chitiet_giohang ch∆∞a
            $sql_check = "SELECT soluong FROM tbl_chitiet_giohang 
                          WHERE code_cart = '$code_cart' AND idsanpham = '$id' LIMIT 1";
            $query_check = mysqli_query($mysqli, $sql_check);

            if (mysqli_num_rows($query_check) > 0) {
                // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng (c·ªông th√™m 1)
                $row_check = mysqli_fetch_array($query_check);
                $old_qty = $row_check['soluong'];
                $new_total_qty = $old_qty + $so_luong_them_moi; // C·ªông th√™m 1
                
                $sql_update = "UPDATE tbl_chitiet_giohang 
                               SET soluong = '$new_total_qty' 
                               WHERE code_cart = '$code_cart' AND idsanpham = '$id'";
                mysqli_query($mysqli, $sql_update);
            } else {
                // Th√™m m·ªõi v√†o DB (s·ªë l∆∞·ª£ng l√† 1)
                $sql_insert = "INSERT INTO tbl_chitiet_giohang (code_cart, idsanpham, soluong) 
                               VALUES ('$code_cart', '$id', '$so_luong_them_moi')";
                mysqli_query($mysqli, $sql_insert);
            }
        }
    }
    
    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang gi·ªè h√†ng
    $_SESSION['message'] = '‚úÖ Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!';
    header('Location: ../../index.php?quanly=giohang');
    exit();
}



// X·ª≠ l√Ω X√≥a nhi·ªÅu s·∫£n ph·∫©m b·∫±ng AJAX (Y√äU C·∫¶U M·ªöI)
if (isset($_POST['action']) && $_POST['action'] == 'delete_multiple' && isset($_POST['ids'])) {
    
    $ids_string = $_POST['ids']; // Chu·ªói ID: "1,5,10"
    $ids_array = explode(',', $ids_string);
    
    $success = false;

    if (!empty($ids_array)) {
        // Chuy·ªÉn m·∫£ng ID th√†nh chu·ªói an to√†n cho SQL (v√≠ d·ª•: '1','5','10')
        $safe_ids = array_map(function($id) use ($mysqli) {
            return "'" . mysqli_real_escape_string($mysqli, trim($id)) . "'";
        }, $ids_array);
        
        $ids_for_sql = implode(',', $safe_ids);

        // 1. X√≥a kh·ªèi Session Cart
        foreach ($ids_array as $id_to_delete) {
            foreach ($_SESSION['cart'] as $key => $item) {
                if ($item['id'] == $id_to_delete) {
                    unset($_SESSION['cart'][$key]);
                    break;
                }
            }
        }
        // ƒê·∫£m b·∫£o session ƒë∆∞·ª£c ƒë√°nh l·∫°i key sau khi x√≥a
        $_SESSION['cart'] = array_values($_SESSION['cart']);

        // 2. X√≥a kh·ªèi DB n·∫øu kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p
        if ($id_khachhang && $code_cart) {
            $code_cart_safe = mysqli_real_escape_string($mysqli, $code_cart);
            
            $sql_delete_db = "DELETE FROM tbl_chitiet_giohang 
                              WHERE code_cart = '$code_cart_safe' AND idsanpham IN ($ids_for_sql)";
            
            if (mysqli_query($mysqli, $sql_delete_db)) {
                $success = true;
            }
        } else {
             // N·∫øu kh√¥ng ƒëƒÉng nh·∫≠p, vi·ªác x√≥a Session ƒë√£ l√† th√†nh c√¥ng
             $success = true;
        }
    }
    
    header('Content-Type: application/json');
    echo json_encode(['success' => $success]);
    exit;
}


// X·ª≠ l√Ω X√≥a nhi·ªÅu s·∫£n ph·∫©m b·∫±ng AJAX (Y√äU C·∫¶U ƒê√É S·ª¨A)
if (isset($_POST['action']) && $_POST['action'] == 'delete_multiple' && isset($_POST['ids'])) {
    
    // ƒê·∫£m b·∫£o d·ªØ li·ªáu ƒë·∫ßu v√†o l√† h·ª£p l·ªá
    $ids_string = $_POST['ids']; // Chu·ªói ID: "1,5,10"
    $ids_array = explode(',', $ids_string);
    
    $success = false;
    $message = 'ƒê√£ x√≥a th√†nh c√¥ng c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn.';

    if (!empty($ids_array)) {
        
        // 1. X√≥a kh·ªèi Session Cart
        foreach ($ids_array as $id_to_delete) {
            // D√πng array_filter ƒë·ªÉ x√≥a an to√†n h∆°n v√† kh√¥ng c·∫ßn ph·∫£i re-index ngay l·∫≠p t·ª©c
            $_SESSION['cart'] = array_filter($_SESSION['cart'], function($item) use ($id_to_delete) {
                return $item['id'] != $id_to_delete;
            });
        }
        // ƒê·∫£m b·∫£o session ƒë∆∞·ª£c ƒë√°nh l·∫°i key sau khi x√≥a
        $_SESSION['cart'] = array_values($_SESSION['cart']);

        // 2. X√≥a kh·ªèi DB n·∫øu kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p v√† c√≥ code_cart
        if ($id_khachhang && $code_cart) {
            
            // Chu·∫©n b·ªã ID an to√†n cho SQL (v√≠ d·ª•: '1','5','10')
            $safe_ids = array_map(function($id) use ($mysqli) {
                return "'" . mysqli_real_escape_string($mysqli, trim($id)) . "'";
            }, $ids_array);
            
            $ids_for_sql = implode(',', $safe_ids);
            
            $code_cart_safe = mysqli_real_escape_string($mysqli, $code_cart);
            
            $sql_delete_db = "DELETE FROM tbl_chitiet_giohang 
                              WHERE code_cart = '$code_cart_safe' AND idsanpham IN ($ids_for_sql)";
            
            if (mysqli_query($mysqli, $sql_delete_db)) {
                $success = true;
            } else {
                 $message = 'ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng (session), nh∆∞ng l·ªói khi x√≥a kh·ªèi Database.';
            }
        } else {
             // N·∫øu kh√¥ng ƒëƒÉng nh·∫≠p, vi·ªác x√≥a Session ƒë√£ l√† th√†nh c√¥ng
             $success = true;
        }
    } else {
        $message = 'Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn.';
    }
    
    header('Content-Type: application/json');
    echo json_encode([
        'success' => $success,
        'message' => $message
    ]);
    exit;
}

// ‚úÖ Xo√° s·∫£n ph·∫©m theo ID (D√πng cho n√∫t "X√≥a" tr√™n t·ª´ng d√≤ng s·∫£n ph·∫©m)
if (isset($_GET['xoa'])) {
    $id_to_delete = $_GET['xoa'];

    // 1. X√≥a kh·ªèi Session Cart
    // Lo·∫°i b·ªè s·∫£n ph·∫©m c√≥ ID tr√πng kh·ªèi session
    $_SESSION['cart'] = array_filter($_SESSION['cart'], function($item) use ($id_to_delete) {
        return $item['id'] != $id_to_delete;
    });
    // ƒê√°nh l·∫°i key cho m·∫£ng session
    $_SESSION['cart'] = array_values($_SESSION['cart']);

    // 2. X√≥a kh·ªèi DB n·∫øu kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p v√† c√≥ m√£ gi·ªè h√†ng
    if ($id_khachhang && $code_cart) {
        $id_safe = mysqli_real_escape_string($mysqli, $id_to_delete);
        $code_cart_safe = mysqli_real_escape_string($mysqli, $code_cart);

        $sql_delete_db = "DELETE FROM tbl_chitiet_giohang 
                          WHERE code_cart = '$code_cart_safe' AND idsanpham = '$id_safe'";
        mysqli_query($mysqli, $sql_delete_db);
    }

    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang gi·ªè h√†ng ch√≠nh x√°c
    $_SESSION['message'] = 'üóëÔ∏è ƒê√£ xo√° 1 s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng.';
    header('Location: ../../index.php?quanly=giohang');
    exit;
}

//th√™m s·ªë l∆∞·ª£ng
if (isset($_GET['cong'])) {
    $id = $_GET['cong'];
    $sql_pro = "SELECT * FROM tbl_sanpham WHERE tbl_sanpham.idsanpham = '" . $id . "' LIMIT 1";
    $pro = mysqli_query($mysqli, $sql_pro);
    $row = mysqli_fetch_array($pro);
    foreach ($_SESSION['cart'] as $cart_item) {
        if ($cart_item['id'] != $id) {
            $product[] = array(
                'tensanpham' => $cart_item['tensanpham'],
                'id' => $cart_item['id'],
                'soluong' => $cart_item['soluong'],
                'giaban' => $cart_item['giaban'],
                'hinhanh' => $cart_item['hinhanh'],
                'masanpham' => $cart_item['masanpham']
            );
            $_SESSION['cart'] = $product;
        } else {
            if ($cart_item['soluong'] < $row['so_luong_con_lai']) {
                $tangso_luong = $cart_item['soluong'] + 1;
                $product[] = array(
                    'tensanpham' => $cart_item['tensanpham'],
                    'id' => $cart_item['id'],
                    'soluong' => $cart_item['soluong'],
                    'giaban' => $cart_item['giaban'],
                    'hinhanh' => $cart_item['hinhanh'],
                    'masanpham' => $cart_item['masanpham']
                );
            } else {
                $product[] = array(
                    'tensanpham' => $cart_item['tensanpham'],
                    'id' => $cart_item['id'],
                    'soluong' => $cart_item['soluong'],
                    'giaban' => $cart_item['giaban'],
                    'hinhanh' => $cart_item['hinhanh'],
                    'masanpham' => $cart_item['masanpham']
                );
            }
            $_SESSION['cart'] = $product;
        }
    }
    header('Location:../../index.php?quanly=giohang');
}
// tr·ª´ s·ªë l∆∞·ª£ng
if (isset($_GET['tru'])) {
    $id = $_GET['tru'];
    foreach ($_SESSION['cart'] as $cart_item) {
        if ($cart_item['id'] != $id) {
            $product[] = array(
                'tensanpham' => $cart_item['tensanpham'],
                'id' => $cart_item['id'],
                'soluong' => $cart_item['soluong'],
                'giaban' => $cart_item['giaban'],
                'hinhanh' => $cart_item['hinhanh'],
                'masanpham' => $cart_item['masanpham']
            );
            $_SESSION['cart'] = $product;
        } else {
            if ($cart_item['soluong'] > 1) {
                $tangso_luong = $cart_item['soluong'] - 1;
                $product[] = array(
                    'tensanpham' => $cart_item['tensanpham'],
                    'id' => $cart_item['id'],
                    'soluong' => $cart_item['soluong'],
                    'giaban' => $cart_item['giaban'],
                    'hinhanh' => $cart_item['hinhanh'],
                    'masanpham' => $cart_item['masanpham']
                );
            } else {
            }
            $_SESSION['cart'] = $product;
        }
    }
    header('Location:../../index.php?quanly=giohang');
}
