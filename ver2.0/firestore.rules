rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check admin status using EITHER Custom Claim OR Admin Ledger.
    function isAdmin() {
      return request.auth != null && (
        (request.auth.token != null && request.auth.token.admin == true) ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }

    // --- Core Authentication / User Management ---

    // Admins: Only the user associated with the admin doc can manage it.
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.uid == adminId;
    }

    // Users: Public read for login lookups. Users can manage their own profile.
    match /users/{userId} {
      allow read: if true; // Public read for account lookups.
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // --- Chat / Support ---

    // Chats: Only the owning user or admins can manage the chat document.
    match /chats/{chatId} {
      // Create: Must be authenticated and doc's userId must match the requester.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Read: Admins or any authenticated user.
      allow read: if isAdmin() || (request.auth != null);
      // Update/Delete: Admins or the owning user.
      allow update, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // Support Requests: Customers can create. Only admins can manage.
    match /support_requests/{reqId} {
      allow create: if request.auth != null; // Must be logged in to create.
      allow read, update, delete: if isAdmin(); // Only admins can manage existing requests.
    }

    // --- Product / E-commerce ---

    // Categories: Public read. Writes restricted to admins for consistency.
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Products: Public read for listing. Writes restricted to admins.
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Reviews: Public read. Authenticated users can write.
    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Cart: Only the authenticated owner can manage their cart (cartId must match uid).
    match /cart/{cartId} {
      // Create: Must be authenticated and cartId matches user uid.
      allow create: if request.auth != null && request.auth.uid == cartId;
      // Read/Write: Must be authenticated and document's ID/userID matches current user.
      allow read, update, delete: if request.auth != null &&
        (resource.data.userID == request.auth.uid || cartId == request.auth.uid);
    }

    // Orders: Users can create/read/manage their own orders. Admins can manage all.
    match /orders/{orderId} {
      // Create: Must be authenticated and order.userID must match the requester.
      allow create: if request.auth != null && request.resource.data.userID == request.auth.uid;

      // Read/Update/Delete: Owner or Admin.
      allow read, update, delete: if isAdmin() || (request.auth != null && resource.data.userID == request.auth.uid);
    }

    // --- Inventory / Warehouse ---

    // Warehouse: Admin-only writes. Authenticated reads.
    match /warehouse/{doc} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Inventory Inbound Entries: Admin-only writes. Authenticated reads.
    // Naming convention unified to /inventory_in/{doc}
    match /inventory_in/{doc} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // --- General Fallback ---

    // Deny all operations on any collection not explicitly defined above.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}