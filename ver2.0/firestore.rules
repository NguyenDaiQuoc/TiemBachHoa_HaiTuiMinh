rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper: Check admin status using either a custom claim or an admin ledger document.
    function isAdmin() {
      return request.auth != null && (
        (request.auth.token != null && request.auth.token.admin == true) ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }

    // -----------------------------
    // Core collections and policies
    // -----------------------------

    // Admins document ledger: a user may only read/write their own admin doc.
    match /admins/{adminId} {
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow write: if isAdmin() && request.auth != null && request.auth.uid == adminId;
    }

    // Users: public read (for profile display), write only by the user.
    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Categories: public read, admin write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Products: public read, admin write. Keep product data publicly viewable.
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Deals / Promotions: public read, admin write
    match /deals/{dealId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Reviews: public read, authenticated users can create.
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null; // must be logged in to post a review
      allow update, delete: if isAdmin() || (request.auth != null && resource.data.userID == request.auth.uid);
    }

    // Cart: each user owns their cart document; cartId should equal uid
    match /cart/{cartId} {
      allow create: if request.auth != null && request.auth.uid == cartId;
      allow read, update, delete: if request.auth != null && (cartId == request.auth.uid || resource.data.userID == request.auth.uid);
    }

    // Orders: creation requires matching userId; reads/writes allowed to owner or admin
    match /orders/{orderId} {
      allow create: if request.auth != null && request.resource.data.userID == request.auth.uid;
      allow read, update, delete: if isAdmin() || (request.auth != null && resource.data.userID == request.auth.uid);
    }

    // Warehouse and Inventory management: reads by authenticated users, writes by admins
    match /warehouse/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    match /inventory_in/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // Vouchers / marketing collections: public read, admin writes
    match /vouchers/{vouchId} { allow read: if true; allow create, update, delete: if isAdmin(); }
    match /email_campaigns/{cId} { allow read: if isAdmin(); allow create, update, delete: if isAdmin(); }
    match /banners/{bId} { allow read: if true; allow create, update, delete: if isAdmin(); }

    // Support requests: any authenticated user can create; admin can manage
    match /support_requests/{reqId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }

    // Chats: authenticated users and admins. Owners can update their chat.
    match /chats/{chatId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null || isAdmin();
      allow update, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // Default deny: explicit whitelist above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}