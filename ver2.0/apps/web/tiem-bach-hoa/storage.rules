rules_version = '2';

// Craft rules based on data in your Firestore database
// allow write: if firestore.get(
//    /databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin;


 // Storage rules with role checks (reads are public; writes restricted by role)
service firebase.storage {
  match /b/{bucket}/o {

    // Simpler, safe rules: require user to be authenticated for writes.
    // Role-based checks (via Firestore get()) are NOT supported reliably
    // inside storage.rules in all projects, and can lead to denies.

    // Public read for all files (adjust if you need private media)
    match /{allPaths=**} {
      allow read: if true;
    }

    // Order-level proofs: restrict writes to admins (or trusted server-side service)
    match /orders/{orderId}/proofs/{allPaths=**} {
      // Proof images are public for viewing by customers/admins who have the URL.
      // Change to `request.auth != null` if you want only authenticated users to view.
      allow read: if true;
      // Require custom claim `admin` to write/delete. Use Firebase Admin SDK to set claims.
      allow write, delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Tracking event images: uploaded by admins/authorized couriers only
    match /orders/{orderId}/tracking/{allPaths=**} {
      allow read: if true;
      allow write, delete: if request.auth != null && request.auth.token.admin == true;
    }

    // Inventory images: require an authenticated user to upload.
    match /inventory_images/{allPaths=**} {
      allow write: if request.auth != null;
      allow read: if true;
    }

    // Product images: require authenticated user (admin UI should ensure only admins upload)
    match /product_images/{allPaths=**} {
      allow write: if request.auth != null;
      allow read: if true;
    }

    // Category icons
    match /category_icons/{iconFile} {
      allow write: if request.auth != null;
      allow read: if true;
    }

    // Blog images
    match /blog_images/{allPaths=**} {
      allow write: if request.auth != null;
      allow read: if true;
    }

    // Other uploads: authenticated users
    match /uploads/{allPaths=**} {
      allow write: if request.auth != null;
      allow read: if true;
    }

    // User-scoped uploads: user may read/write their own files
    match /users/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
