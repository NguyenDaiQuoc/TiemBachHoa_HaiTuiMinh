rules_version = '2';

// Firestore security rules tailored for the app's collections.
// Goal: enable the web app's admin areas (inventory, warehouse, products, notifications)
// while keeping write access restricted to admins where appropriate.

service cloud.firestore {
  match /databases/{database}/documents {

    // -- Helpers ----------------------------------------------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    // isAdmin checks both users and admins collections for admin role
    function isAdmin() {
      return isAuthenticated() && (
        // Check if user exists in admins collection
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        ||
        // OR check if user has admin role in users collection
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid))
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        )
      );
    }

    // -- Publicly readable collections -----------------------------------------
    // Products are public (e.g., storefront). Only admins may write them.
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Categories, banners, blogs, vouchers, deals are public-read, admin-write.
    match /categories/{id} { allow read: if true; allow write: if isAdmin(); }
    match /banners/{id} { allow read: if true; allow write: if isAdmin(); }
    match /blogs/{id}   { allow read: if true; allow write: if isAdmin(); }
    match /vouchers/{id}{ allow read: if true; allow write: if isAdmin(); }
    match /news/{id}    { allow read: if true; allow write: if isAdmin(); }
    match /media/{id}   { allow read: if true; allow write: if isAdmin(); }
    match /deals/{id}   { allow read: if true; allow write: if isAdmin(); }

    // -- Warehouse & Inventory (admin area) -----------------------------------
    // Warehouse stores items that admins manage. Allow admins full access.
    // Allow authenticated read so staff UI can show warehouse lists if needed.
    match /warehouse/{warehouseId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Admins collection: allow a user to read their own admin document after sign-in
    // so login flow can verify role. Writes remain admin-only.
    match /admins/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow create, update, delete: if isAdmin();
    }

    // Inventory in (incoming receipts) should be admin-managed only.
    match /inventory_in/{invId} {
      // Inventory records should be readable by authenticated staff/admin UI.
      // Allow any authenticated user to read inventory entries so the admin UI (when
      // authenticated) can load them. Creation/update/delete remain admin-only.
      allow read: if isAuthenticated();
      // Allow admins to create inventory records
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // -- Orders ---------------------------------------------------------------
    // Orders may be created by clients (allow public create but validate shape).
    // Reading/updating orders is limited to order owner or admin.
    match /orders/{orderId} {
      allow create: if (
        // basic validation: must contain an items array with at least one entry
        request.resource.data.items is list
        && request.resource.data.items.size() > 0
        // totalAmount should be a number (can be 0)
        && (request.resource.data.totalAmount is number)
      );

      // Allow authenticated read for admin UI notifications. Creation remains validated.
      allow read: if isAuthenticated();
      allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // -- Users ----------------------------------------------------------------
    // Users can read/write their own document. Admins can read/write any user doc.
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }

    // -- Chats & messages -----------------------------------------------------
    // Chat creation and messages allowed only for authenticated participants.
    match /chats/{chatId} {
      // Allow authenticated users to create their chat docs, or allow public creation when explicitly marked isPublic
      allow create: if isAuthenticated() || (request.resource.data.isPublic == true);
      // Allow reads if authenticated, admin, or explicitly public
      allow read: if isAuthenticated() || isAdmin() || (resource.data.isPublic == true);
      // Allow updates if admin, participant, or explicitly public
      allow update: if isAdmin() || (isAuthenticated() && (request.auth.uid in resource.data.participants)) || (resource.data.isPublic == true);
      allow delete: if isAdmin();

      match /messages/{messageId} {
        // message create requires senderId to match caller or isPublic chat
        allow create: if (isAuthenticated() && request.resource.data.senderId == request.auth.uid) || (get(/databases/$(database)/documents/chats/$(chatId)).data.isPublic == true);
        allow read: if isAdmin() || (isAuthenticated() && (request.auth.uid in resource.data.participants)) || (get(/databases/$(database)/documents/chats/$(chatId)).data.isPublic == true);
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.senderId == request.auth.uid);
      }
    }

    // -- Reviews --------------------------------------------------------------
    // Reviews are publicly readable. Users can create reviews for products.
    // Only admins or review authors can update/delete reviews.
    match /reviews/{reviewId} {
      allow read: if true; // Public read for all users
      allow create: if isAuthenticated(); // Authenticated users can write reviews
      allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // -- Cart -----------------------------------------------------------------
    // Cart items can only be read/written by the cart owner or admin.
    match /cart/{cartId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userID == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.userID == request.auth.uid;
      allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userID == request.auth.uid);
    }

    // -- Admin-only fallback -------------------------------------------------
    // Any other collections/documents are restricted to admins by default.
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
