rules_version = '2';

// Firestore security rules tailored for the app's collections.
// Goal: enable the web app's admin areas (inventory, warehouse, products, notifications)
// while keeping write access restricted to admins where appropriate.

service cloud.firestore {
  match /databases/{database}/documents {

    // -- Helpers ----------------------------------------------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    // isAdmin checks users collection for a role field equal to 'admin'
    function isAdmin() {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // -- Publicly readable collections -----------------------------------------
    // Products are public (e.g., storefront). Only admins may write them.
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Categories, banners, blogs, vouchers are public-read, admin-write.
    match /categories/{id} { allow read: if true; allow write: if isAdmin(); }
    match /banners/{id} { allow read: if true; allow write: if isAdmin(); }
    match /blogs/{id}   { allow read: if true; allow write: if isAdmin(); }
    match /vouchers/{id}{ allow read: if true; allow write: if isAdmin(); }
    match /news/{id}    { allow read: if true; allow write: if isAdmin(); }
    match /media/{id}   { allow read: if true; allow write: if isAdmin(); }

    // -- Warehouse & Inventory (admin area) -----------------------------------
    // Warehouse stores items that admins manage. Allow admins full access.
    // Allow authenticated read so staff UI can show warehouse lists if needed.
    match /warehouse/{warehouseId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Admins collection: allow a user to read their own admin document after sign-in
    // so login flow can verify role. Writes remain admin-only.
    match /admins/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow create, update, delete: if isAdmin();
    }

    // Inventory in (incoming receipts) should be admin-managed only.
    match /inventory_in/{invId} {
      // Inventory records should be readable by authenticated staff/admin UI.
      // Allow any authenticated user to read inventory entries so the admin UI (when
      // authenticated) can load them. Creation/update/delete remain admin-only.
      allow read: if isAuthenticated();
      // only admins may create inventory records; require adminId to match caller
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin();
    }

    // -- Orders ---------------------------------------------------------------
    // Orders may be created by clients (allow public create but validate shape).
    // Reading/updating orders is limited to order owner or admin.
    match /orders/{orderId} {
      allow create: if (
        // basic validation: must contain an items array with at least one entry
        request.resource.data.items is list
        && request.resource.data.items.size() > 0
        // totalAmount should be a number (can be 0)
        && (request.resource.data.totalAmount is number)
      );

      // Allow authenticated read for admin UI notifications. Creation remains validated.
      allow read: if isAuthenticated();
      allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // -- Users ----------------------------------------------------------------
    // Users can read/write their own document. Admins can read/write any user doc.
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }

    // -- Chats & messages -----------------------------------------------------
    // Chat creation and messages allowed only for authenticated participants.
    match /chats/{chatId} {
      allow create: if isAuthenticated() && (request.auth.uid in request.resource.data.participants);
      // Allow authenticated reads so admin UI can list recent chats for notifications.
      allow read: if isAuthenticated();
      allow update, delete: if isAdmin() || (isAuthenticated() && (request.auth.uid in resource.data.participants));

      match /messages/{messageId} {
        // message create requires senderId to match caller
        allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
        allow read: if isAdmin() || (isAuthenticated() && (request.auth.uid in resource.data.participants));
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.senderId == request.auth.uid);
      }
    }

    // -- Admin-only fallback -------------------------------------------------
    // Any other collections/documents are restricted to admins by default.
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
